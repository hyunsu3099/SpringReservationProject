<?xml version="1.0" encoding="UTF-8"?>
<!--
   MemberDaoMapper.xml
   로그인 관련 DAO 쿼리 매핑
   
   작성자 : 이현수 yzhs.go@gmail.com
   작성일 : 2022-11-29, 최종수정 2022-12-1
-->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.springreservation.web.dao.BoardDao">
    <resultMap type="com.springreservation.web.entity.Board" id="board">
            <id column="id" property="id"/>
            <result column="user_name" property="userName" />
            <result column="reg_date" property="regDate" />
            <result column="edit_date" property="editDate" />
    </resultMap>

    <!-- 게시판 뷰에서 목록을 요청했을 때-->
    <select id="getList" resultMap="board">
        SELECT id, title, user_name, reg_date, edit_date, publish, hit
        FROM (SELECT rownum as r, id, title, user_name, reg_date, edit_date, publish, hit
                FROM
                (
                    SELECT * FROM board
                    WHERE
                        ${key} LIKE '%${val}%'
                        <if test = "!#{isAdmin}">AND publish=1</if>
                    ORDER by id DESC
                )
            WHERE rownum &lt; #{limit}
        )
        WHERE
            r &gt; #{offset}
    </select>

     <!-- 글 개수 확인-->
    <select id="getCounts" resultType="int">
        SELECT count(id)
        FROM board
        WHERE
            ${key} LIKE '%${val}%'
            <if test = "!#{isAdmin}">AND publish=1</if>
    </select>


    <!--detail 뷰 혹은, 수정하기 뷰를 요청 했을 때-->
    <select id="get" resultMap="board">
        SELECT  id, title, user_name, reg_date, edit_date, publish, content, hit
        FROM board
        WHERE id = #{id}
        <if test = "!#{isAdmin}">AND publish=1</if>
    </select>

    <!--detail 뷰 혹은, 수정하기 뷰를 요청 했을 때, 이전글 정보-->
    <select id="getPrev" resultMap="board">
        SELECT  id, title
        FROM board
        WHERE 
            rownum = 
                (
                    SELECT  rownum FROM
                        (
                        SELECT id FROM board
                        <if test = "!#{isAdmin}">WHERE publish=1</if>
                        ORDER by id DESC
                        )
                    WHERE id = #{id}
                )-1
    </select>

    <!--detail 뷰 혹은, 수정하기 뷰를 요청 했을 때, 다음글 정보-->
    <select id="getNext" resultMap="board">
        SELECT  id, title
        FROM board
        WHERE 
            rownum = 
                (
                    SELECT rownum FROM
                        (
                        SELECT id FROM board
                        <if test = "!#{isAdmin}">WHERE publish=1</if>
                        ORDER by id DESC
                        )
                    WHERE id = #{id}
                )+1
    </select>

    <!--post 요청을 보냈을 때-->
    <insert id="create" parameterType="com.springreservation.web.entity.Board">
        INSERT INTO board(
            id, user_name, title, content, reg_date, edit_date, publish
        )VALUES(
            board_seq.nextval,
            '${userName}' ,
            '${title}' ,
            '${content}',
            sysdate ,
            sysdate ,
            #{publish}
        )
    </insert>

    <!--update 요청 할 때, publish 게시 상태 전환-->
    <update id="update" parameterType="com.springreservation.web.entity.Board">
        UPDATE board
        SET content = '${content}',
            title = '${title}',
            publish = #{publish},
            edit_date = sysdate
        WHERE id = #{id}
    </update>


    <!--patch 요청 할 때, publish 게시 상태 전환-->
    <update id="patch">
        UPDATE board
        SET publish = 1-(
                SELECT publish FROM board WHERE id = #{id} 
            )
        WHERE id = #{id}
    </update>

    <!--delete 요청 할 때 게시클 칼럼 삭제-->
    <delete id="delete">
        DELETE FROM board
        WHERE id = #{id}
    </delete>

    <!--update 요청 할 때, publish 게시 상태 전환-->
    <update id="hit">
        UPDATE board
        SET 
            hit = (
                SELECT hit 
                FROM board 
                WHERE id = #{id}) +1
        WHERE id = #{id}
    </update>

</mapper>